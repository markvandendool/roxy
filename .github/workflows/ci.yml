name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check Python syntax
        run: |
          python -m py_compile roxy_core.py
          python -m py_compile benchmark_service.py
          python -m py_compile pool_identity.py
          python -m py_compile prometheus_metrics.py
          echo "Syntax check passed"

      - name: Check shell scripts
        run: |
          bash -n scripts/prod_deploy.sh
          bash -n scripts/wait-for-ready.sh
          bash -n scripts/gateA_resilience.sh
          bash -n scripts/gateB_overload.sh
          bash -n scripts/gateE_observability.sh
          bash -n scripts/gate2_smoke.sh
          echo "Shell syntax check passed"

  # Production gates require local hardware (GPUs, ollama instances)
  # Run locally: ~/.roxy/scripts/prod_deploy.sh
  gate-docs:
    name: Gate Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Document gate requirements
        run: |
          echo "================================================"
          echo "PRODUCTION GATES (require local execution)"
          echo "================================================"
          echo ""
          echo "Gate0 (prod_deploy.sh): Full deploy cycle"
          echo "  - Requires: systemd, ollama on 11434/11435"
          echo ""
          echo "GateA (gateA_resilience.sh): Pool resilience"
          echo "  - Requires: Running roxy-core, reachable pools"
          echo ""
          echo "GateB (gateB_overload.sh): Overload protection"
          echo "  - Requires: Running roxy-core, auth token"
          echo ""
          echo "GateE (gateE_observability.sh): Metrics verification"
          echo "  - Requires: Running roxy-core, prometheus_client"
          echo ""
          echo "Run locally: ~/.roxy/scripts/prod_deploy.sh"
          echo "See: docs/RUNBOOK.md for operator instructions"
          echo "================================================"
